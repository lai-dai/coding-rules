name: Pull Request Validation

on:
  pull_request:
    branches:
      - '**'  # √Åp d·ª•ng cho t·∫•t c·∫£ c√°c branch

jobs:
  validate-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate branch status
        env:
          GITHUB_TOKEN: ${{ secrets.PAT }}
        run: |
          BASE_BRANCH="${{ github.base_ref }}"
          HEAD_BRANCH="${{ github.head_ref }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"

          git fetch origin $BASE_BRANCH
          git fetch origin $HEAD_BRANCH

          # Ki·ªÉm tra nh√°nh c√≥ c·∫≠p nh·∫≠t kh√¥ng
          if ! git merge-base --is-ancestor origin/$BASE_BRANCH origin/$HEAD_BRANCH; then
            MESSAGE="‚ö†Ô∏è C·∫≠p nh·∫≠t y√™u c·∫ßu: Nh√°nh '$HEAD_BRANCH' c·∫ßn ƒë∆∞·ª£c c·∫≠p nh·∫≠t v·ªõi '$BASE_BRANCH'.

            Vui l√≤ng th·ª±c hi·ªán c√°c b∆∞·ªõc sau:
            \`\`\`
            git checkout $HEAD_BRANCH
            git fetch origin $BASE_BRANCH
            git rebase origin/$BASE_BRANCH
            git push origin $HEAD_BRANCH --force-with-lease
            \`\`\`"
            echo "$MESSAGE"
            gh pr comment $PR_NUMBER --body "$MESSAGE"
            exit 1
          fi

          # Ki·ªÉm tra xung ƒë·ªôt
          if git merge-tree $(git merge-base $BASE_BRANCH $HEAD_BRANCH) $BASE_BRANCH $HEAD_BRANCH | grep -q "^++<<<<<<< "; then
            MESSAGE="üîÄ Xung ƒë·ªôt ph√°t hi·ªán: C√≥ xung ƒë·ªôt gi·ªØa '$HEAD_BRANCH' v√† '$BASE_BRANCH'.

            Vui l√≤ng gi·∫£i quy·∫øt xung ƒë·ªôt:
            \`\`\`
            git checkout $HEAD_BRANCH
            git fetch origin $BASE_BRANCH
            git rebase origin/$BASE_BRANCH
            # Gi·∫£i quy·∫øt xung ƒë·ªôt
            git add .
            git rebase --continue
            git push origin $HEAD_BRANCH --force-with-lease
            \`\`\`"
            echo "$MESSAGE"
            gh pr comment $PR_NUMBER --body "$MESSAGE"
            exit 1
          fi

          echo "‚úÖ Nh√°nh h·ª£p l·ªá: '$HEAD_BRANCH' ƒë√£ c·∫≠p nh·∫≠t v·ªõi '$BASE_BRANCH' v√† kh√¥ng c√≥ xung ƒë·ªôt."

  code-quality:
    runs-on: ubuntu-latest
    needs: validate-pr
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint
        env:
          SKIP_ENV_VALIDATION: true
        continue-on-error: true

      - name: Build project
        run: npm run build
        env:
          SKIP_ENV_VALIDATION: true
